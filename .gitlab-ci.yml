stages:
  - test
  - tag
  - publish

variables:
  GIT_DEPTH: 0  # Full clone for proper version detection

# Test stage - run on every commit
test:
  stage: test
  image: php:8.2-cli
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git zip unzip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --no-interaction --prefer-dist
  script:
    - composer validate --strict
    - composer phpstan
    - composer cs-check
    - composer test
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - vendor/
  only:
    - branches
    - merge_requests

# Auto-tag stage - create version tag based on commit message
auto-tag:
  stage: tag
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl jq bash
    - git config user.email "ci@hiroshiaki.com"
    - git config user.name "GitLab CI"
  script:
    - |
      #!/bin/bash
      set -e
      
      # Get the latest tag
      LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
      echo "Latest tag: $LATEST_TAG"
      
      # Remove 'v' prefix and split version
      VERSION=${LATEST_TAG#v}
      IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
      
      # Determine version bump based on commit message
      COMMIT_MSG=$(git log -1 --pretty=%B)
      echo "Commit message: $COMMIT_MSG"
      
      if echo "$COMMIT_MSG" | grep -qiE "^(breaking|major):"; then
        MAJOR=$((MAJOR + 1))
        MINOR=0
        PATCH=0
        VERSION_TYPE="major"
      elif echo "$COMMIT_MSG" | grep -qiE "^(feat|feature|minor):"; then
        MINOR=$((MINOR + 1))
        PATCH=0
        VERSION_TYPE="minor"
      elif echo "$COMMIT_MSG" | grep -qiE "^(fix|patch|chore|docs|style|refactor|perf|test):"; then
        PATCH=$((PATCH + 1))
        VERSION_TYPE="patch"
      else
        echo "No version bump trigger found in commit message. Skipping tag creation."
        echo "Use prefixes: breaking:/major:, feat:/feature:/minor:, fix:/patch:/chore:/docs:"
        touch tag.env
        exit 0
      fi
      
      NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
      echo "Creating new tag: $NEW_TAG (${VERSION_TYPE} version bump)"
      
      # Create annotated tag
      git tag -a "$NEW_TAG" -m "Release $NEW_TAG - Automated release by GitLab CI

      $COMMIT_MSG"
      
      # Push tag using GitLab CI credentials
      git push "https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$NEW_TAG"
      
      echo "Tag $NEW_TAG created and pushed successfully!"
      echo "NEW_TAG=$NEW_TAG" >> tag.env
  artifacts:
    reports:
      dotenv: tag.env
  only:
    - main
    - master
  except:
    - tags

# Notify Packagist - trigger package update after tagging
notify-packagist:
  stage: publish
  image: curlimages/curl:latest
  script:
    - |
      if [ -z "$PACKAGIST_USERNAME" ] || [ -z "$PACKAGIST_API_TOKEN" ]; then
        echo "⚠️  PACKAGIST_USERNAME or PACKAGIST_API_TOKEN not set in GitLab CI/CD variables"
        echo "Please set these variables in: GitLab Project > Settings > CI/CD > Variables"
        echo "Get your API token from: https://packagist.org/profile/"
        exit 1
      fi
      
      echo "Notifying Packagist about new release..."
      RESPONSE=$(curl -X POST \
        "https://packagist.org/api/update-package?username=${PACKAGIST_USERNAME}&apiToken=${PACKAGIST_API_TOKEN}" \
        -H "Content-Type: application/json" \
        -d '{"repository":{"url":"https://gitlab.hiroshiaki.com:8886/hiroshi-aki/datafabric-sdk-php"}}' \
        -w "\n%{http_code}" \
        -s)
      
      HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
      BODY=$(echo "$RESPONSE" | head -n -1)
      
      if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
        echo "✅ Packagist notified successfully!"
        echo "Response: $BODY"
      else
        echo "❌ Failed to notify Packagist (HTTP $HTTP_CODE)"
        echo "Response: $BODY"
        exit 1
      fi
  only:
    - tags
  when: on_success

# Manual tag creation job (optional - for manual releases)
manual-tag:
  stage: tag
  image: alpine:latest
  before_script:
    - apk add --no-cache git
    - git config user.email "ci@hiroshiaki.com"
    - git config user.name "GitLab CI"
  script:
    - |
      if [ -z "$TAG_VERSION" ]; then
        echo "Error: TAG_VERSION variable is required"
        echo "Run this job manually with TAG_VERSION variable set (e.g., v1.2.3)"
        exit 1
      fi
      
      echo "Creating manual tag: $TAG_VERSION"
      git tag -a "$TAG_VERSION" -m "Release $TAG_VERSION - Manual release"
      git push "https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$TAG_VERSION"
      echo "Tag $TAG_VERSION created and pushed successfully!"
  only:
    - main
    - master
  when: manual
  allow_failure: false
